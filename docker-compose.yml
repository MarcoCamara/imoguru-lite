version: "3.9"

services:
  # -------------------------------------------------
  # 游 Backend - Node.js
  # -------------------------------------------------
  rose-backend:
    container_name: rose-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: rose-backend:latest
    restart: unless-stopped

    # Mapeamento de portas (externa:interna) - configur치vel via vari치vel
    ports:
      - "${BACKEND_PORT:-3001}:3001"

    # Carrega vari치veis de ambiente (opcional, se existir deploy.env)
    env_file:
      - ./deploy.env

    # Vari치veis b치sicas do container
    environment:
      NODE_ENV: production
      PORT: 3001
      TZ: America/Sao_Paulo

    # Healthcheck (para reiniciar se falhar)
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

    networks:
      - imoguru_net

  # -------------------------------------------------
  # 游눑 Frontend - React (Vite Build + Serve)
  # -------------------------------------------------
  rose-frontend:
    container_name: rose-frontend
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:3001}
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY}
    image: rose-frontend:latest
    restart: unless-stopped

    # Porta configur치vel via vari치vel de ambiente (padr칚o: 3000 para evitar conflito com porta 80)
    ports:
      - "${FRONTEND_PORT:-3000}:80"

    depends_on:
      - rose-backend

    environment:
      NODE_ENV: production
      TZ: America/Sao_Paulo

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

    networks:
      - imoguru_net

# -------------------------------------------------
# 游깷 Rede interna isolada
# -------------------------------------------------
networks:
  imoguru_net:
    driver: bridge
