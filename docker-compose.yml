#version: "3.9"

services:
  # -------------------------------------------------
  # üß† Backend - Node.js
  # -------------------------------------------------
  rose-backend:
    container_name: rose-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: rose-backend:latest
    restart: unless-stopped

    # Mapeamento de portas (externa:interna)
    ports:
      - "8080:3001"

    # Carrega vari√°veis de ambiente (opcional, se existir deploy.env)
    env_file:
      - ./deploy.env

    # Vari√°veis b√°sicas do container
    environment:
      NODE_ENV: production
      PORT: 3001
      TZ: America/Sao_Paulo

    # Healthcheck (para reiniciar se falhar)
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

    networks:
      - imoguru_net

  # -------------------------------------------------
  # üíé Frontend - React (Vite Build + Serve)
  # -------------------------------------------------
  rose-frontend:
    container_name: rose-frontend
    build:
      context: .
      dockerfile: Dockerfile
    image: rose-frontend:latest
    restart: unless-stopped

    # O frontend sempre exp√µe porta 80 (EasyPanel publica essa automaticamente)
    ports:
      - "80:80"

    depends_on:
      - rose-backend

    environment:
      NODE_ENV: production
      TZ: America/Sao_Paulo

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

    networks:
      - imoguru_net

# -------------------------------------------------
# üåê Rede interna isolada
# -------------------------------------------------
networks:
  imoguru_net:
    driver: bridge
