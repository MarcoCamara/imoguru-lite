# üì° Documenta√ß√£o das APIs - ImoGuru

## üéØ Vis√£o Geral

O ImoGuru oferece duas APIs RESTful para integra√ß√£o externa com agentes de IA, automa√ß√µes (n8n, Zapier) e outros sistemas:

1. **API de Im√≥veis**: Acesso aos im√≥veis cadastrados
2. **API de Solicita√ß√µes de Contato**: Acesso √†s solicita√ß√µes recebidas

Ambas as APIs s√£o **filtradas automaticamente por empresa** e requerem autentica√ß√£o via **API Key**.

---

## üîê Autentica√ß√£o

Todas as requisi√ß√µes devem incluir o header `x-api-key`:

```http
GET /functions/v1/api-properties
x-api-key: sk_abc123def456...
```

### Como obter uma API Key:

1. Acesse **Configura√ß√µes > APIs**
2. Clique em **"Nova API Key"**
3. Preencha:
   - **Nome**: Identifica√ß√£o da chave (ex: "N8N Agente IA")
   - **Empresa**: Empresa que ter√° dados acess√≠veis
   - **Tipo**: `Im√≥veis` ou `Solicita√ß√µes de Contato`
4. **Copie a chave gerada** (n√£o ser√° mostrada novamente!)

---

## üè† API de Im√≥veis

### Endpoint

```
GET {SUPABASE_URL}/functions/v1/api-properties
```

O endpoint √© **din√¢mico** e muda conforme o ambiente configurado em `VITE_SUPABASE_URL`:

**Exemplo (Local):**
```
http://127.0.0.1:54321/functions/v1/api-properties
```

**Exemplo (Supabase Cloud):**
```
https://jjeyaupzjkyuidrxdvso.supabase.co/functions/v1/api-properties
```

**Exemplo (VPS/Self-Hosted):**
```
https://api.seu-dominio.com.br/functions/v1/api-properties
```

> üí° **Dica:** O endpoint correto √© exibido automaticamente em **Configura√ß√µes > APIs > Documenta√ß√£o**

### Headers Obrigat√≥rios

```http
x-api-key: SUA_CHAVE_AQUI
```

### Resposta de Sucesso (200 OK)

```json
{
  "success": true,
  "count": 2,
  "data": [
    {
      "id": "uuid-aqui",
      "code": "IMO-001",
      "title": "Apartamento 2 Quartos",
      "description": "Lindo apartamento...",
      "property_type": "apartamento",
      "purpose": "venda",
      "status": "disponivel",
      "sale_price": 350000,
      "rental_price": null,
      "condominium_fee": 450,
      "iptu": 200,
      "area_total": 80,
      "area_built": 70,
      "bedrooms": 2,
      "bathrooms": 1,
      "suites": 0,
      "parking_spaces": 1,
      "public_address": "Rua das Flores, Centro",
      "city": "S√£o Paulo",
      "state": "SP",
      "neighborhood": "Centro",
      "cep": "01000-000",
      "accepts_exchange": false,
      "available_for_partnership": false,
      "images": [
        "https://exemplo.com/foto1.jpg",
        "https://exemplo.com/foto2.jpg"
      ],
      "features": [
        "Piscina",
        "Academia",
        "Varanda"
      ],
      "created_at": "2024-10-24T10:00:00Z",
      "updated_at": "2024-10-24T12:00:00Z"
    }
  ]
}
```

### Campos Retornados

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | Identificador √∫nico do im√≥vel |
| `code` | String | C√≥digo sequencial (ex: IMO-001) |
| `title` | String | T√≠tulo do im√≥vel |
| `description` | String | Descri√ß√£o completa |
| `property_type` | String | Tipo: apartamento, casa, terreno, etc. |
| `purpose` | String | Finalidade: venda, locacao, venda/locacao |
| `status` | String | Status: disponivel, vendido, alugado, etc. |
| `sale_price` | Number | Pre√ßo de venda (null se n√£o for venda) |
| `rental_price` | Number | Pre√ßo de loca√ß√£o (null se n√£o for loca√ß√£o) |
| `condominium_fee` | Number | Taxa de condom√≠nio |
| `iptu` | Number | Valor do IPTU |
| `area_total` | Number | √Årea total em m¬≤ |
| `area_built` | Number | √Årea constru√≠da em m¬≤ |
| `bedrooms` | Number | N√∫mero de quartos |
| `bathrooms` | Number | N√∫mero de banheiros |
| `suites` | Number | N√∫mero de su√≠tes |
| `parking_spaces` | Number | Vagas de garagem |
| `public_address` | String | Endere√ßo p√∫blico (sem n√∫mero) |
| `city` | String | Cidade |
| `state` | String | Estado (UF) |
| `neighborhood` | String | Bairro |
| `cep` | String | CEP |
| `accepts_exchange` | Boolean | Aceita permuta |
| `available_for_partnership` | Boolean | Dispon√≠vel para parceria |
| `images` | Array | URLs das fotos (ordenadas por display_order) |
| `features` | Array | Caracter√≠sticas (Piscina, Academia, etc.) |
| `created_at` | DateTime | Data de cria√ß√£o |
| `updated_at` | DateTime | Data de atualiza√ß√£o |

### ‚ö†Ô∏è Dados N√ÉO Retornados (Privacidade)

- ‚ùå Nome do propriet√°rio
- ‚ùå CPF/CNPJ do propriet√°rio
- ‚ùå Telefone do propriet√°rio
- ‚ùå Email do propriet√°rio
- ‚ùå Endere√ßo completo (apenas `public_address`)

### Erros Poss√≠veis

**401 Unauthorized** - API Key inv√°lida ou arquivada
```json
{
  "error": "API Key inv√°lida ou arquivada."
}
```

**500 Internal Server Error** - Erro no servidor
```json
{
  "error": "Mensagem de erro detalhada"
}
```

---

## üìû API de Solicita√ß√µes de Contato

### Endpoint

```
GET {SUPABASE_URL}/functions/v1/api-contact-requests
```

O endpoint √© **din√¢mico** e muda conforme o ambiente configurado em `VITE_SUPABASE_URL`:

**Exemplo (Local):**
```
http://127.0.0.1:54321/functions/v1/api-contact-requests
```

**Exemplo (Supabase Cloud):**
```
https://jjeyaupzjkyuidrxdvso.supabase.co/functions/v1/api-contact-requests
```

**Exemplo (VPS/Self-Hosted):**
```
https://api.seu-dominio.com.br/functions/v1/api-contact-requests
```

> üí° **Dica:** O endpoint correto √© exibido automaticamente em **Configura√ß√µes > APIs > Documenta√ß√£o**

### Headers Obrigat√≥rios

```http
x-api-key: SUA_CHAVE_AQUI
```

### Resposta de Sucesso (200 OK)

```json
{
  "success": true,
  "count": 3,
  "pending_count": 2,
  "responded_count": 1,
  "data": [
    {
      "id": "uuid-aqui",
      "contact": {
        "name": "Jo√£o Silva",
        "email": "joao@exemplo.com",
        "phone": "(11) 98765-4321"
      },
      "message": "Tenho interesse no im√≥vel",
      "property": {
        "id": "uuid-do-imovel",
        "code": "IMO-001",
        "title": "Apartamento 2 Quartos",
        "type": "apartamento",
        "purpose": "venda",
        "sale_price": 350000,
        "rental_price": null,
        "location": {
          "public_address": "Rua das Flores, Centro",
          "city": "S√£o Paulo",
          "state": "SP"
        }
      },
      "status": "pending",
      "created_at": "2024-10-24T10:00:00Z",
      "responded_at": null
    }
  ]
}
```

### Campos Retornados

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | Identificador √∫nico da solicita√ß√£o |
| `contact.name` | String | Nome do interessado |
| `contact.email` | String | Email do interessado |
| `contact.phone` | String | Telefone do interessado |
| `message` | String | Mensagem do interessado |
| `property` | Object | Dados resumidos do im√≥vel |
| `property.id` | UUID | ID do im√≥vel |
| `property.code` | String | C√≥digo do im√≥vel |
| `property.title` | String | T√≠tulo do im√≥vel |
| `property.type` | String | Tipo do im√≥vel |
| `property.purpose` | String | Finalidade (venda/locacao) |
| `property.sale_price` | Number | Pre√ßo de venda |
| `property.rental_price` | Number | Pre√ßo de loca√ß√£o |
| `property.location` | Object | Localiza√ß√£o p√∫blica |
| `status` | String | `pending` ou `responded` |
| `created_at` | DateTime | Data da solicita√ß√£o |
| `responded_at` | DateTime | Data da resposta (null se pendente) |

### Resumo de Status

- `pending_count`: Total de solicita√ß√µes n√£o respondidas
- `responded_count`: Total de solicita√ß√µes j√° respondidas
- `count`: Total de solicita√ß√µes

### Erros Poss√≠veis

**401 Unauthorized** - API Key inv√°lida ou arquivada
```json
{
  "error": "API Key inv√°lida ou arquivada."
}
```

**500 Internal Server Error** - Erro no servidor
```json
{
  "error": "Mensagem de erro detalhada"
}
```

---

## ü§ñ Exemplos de Uso

### cURL

**API de Im√≥veis:**
```bash
curl -X GET \
  'https://seu-projeto.supabase.co/functions/v1/api-properties' \
  -H 'x-api-key: sk_abc123def456...'
```

**API de Solicita√ß√µes:**
```bash
curl -X GET \
  'https://seu-projeto.supabase.co/functions/v1/api-contact-requests' \
  -H 'x-api-key: sk_abc123def456...'
```

### JavaScript / Node.js

```javascript
const API_KEY = 'sk_abc123def456...';
const BASE_URL = 'https://seu-projeto.supabase.co/functions/v1';

// Buscar im√≥veis
async function getProperties() {
  const response = await fetch(`${BASE_URL}/api-properties`, {
    headers: {
      'x-api-key': API_KEY
    }
  });
  const data = await response.json();
  console.log(data);
}

// Buscar solicita√ß√µes de contato
async function getContactRequests() {
  const response = await fetch(`${BASE_URL}/api-contact-requests`, {
    headers: {
      'x-api-key': API_KEY
    }
  });
  const data = await response.json();
  console.log(data);
}
```

### Python

```python
import requests

API_KEY = 'sk_abc123def456...'
BASE_URL = 'https://seu-projeto.supabase.co/functions/v1'

# Buscar im√≥veis
def get_properties():
    response = requests.get(
        f'{BASE_URL}/api-properties',
        headers={'x-api-key': API_KEY}
    )
    return response.json()

# Buscar solicita√ß√µes de contato
def get_contact_requests():
    response = requests.get(
        f'{BASE_URL}/api-contact-requests',
        headers={'x-api-key': API_KEY}
    )
    return response.json()
```

### n8n (HTTP Request Node)

**Configura√ß√£o do Node:**
- **Method**: GET
- **URL**: `https://seu-projeto.supabase.co/functions/v1/api-properties`
- **Headers**:
  - **Name**: `x-api-key`
  - **Value**: `sk_abc123def456...`

---

## üîí Seguran√ßa

### Boas Pr√°ticas

‚úÖ **Guarde suas API Keys com seguran√ßa**
- Use vari√°veis de ambiente
- Nunca commit chaves no Git
- Use servi√ßos como Vault para produ√ß√£o

‚úÖ **Monitore o uso**
- Acompanhe o contador de usos
- Verifique o √∫ltimo uso
- Arquive chaves n√£o utilizadas

‚úÖ **Rota√ß√£o de Chaves**
- Crie nova chave
- Atualize suas integra√ß√µes
- Arquive/delete a chave antiga

‚úÖ **Princ√≠pio do Menor Privil√©gio**
- Crie chaves espec√≠ficas por integra√ß√£o
- Use uma chave para im√≥veis, outra para contatos
- Facilita auditoria e revoga√ß√£o

### Limita√ß√µes

- üîê Cada API Key √© vinculada a **uma empresa**
- üîê Dados s√£o **automaticamente filtrados**
- üîê Chaves arquivadas **n√£o funcionam**
- üîê Apenas **admins** podem criar/gerenciar APIs

---

## üìä Monitoramento

### M√©tricas Dispon√≠veis

Cada API Key rastreia:
- **Contador de Usos**: Total de requisi√ß√µes
- **√öltimo Uso**: Data/hora da √∫ltima requisi√ß√£o
- **Status**: Ativa ou Arquivada

### Como Monitorar

1. Acesse **Configura√ß√µes > APIs**
2. Veja a tabela com todas as chaves
3. Colunas: Nome, Tipo, Empresa, Usos, √öltimo Uso, Status

---

## üõ†Ô∏è Troubleshooting

### Problema: "API Key n√£o fornecida"
**Solu√ß√£o**: Adicione o header `x-api-key` √† requisi√ß√£o

### Problema: "API Key inv√°lida ou arquivada"
**Poss√≠veis causas:**
- Chave copiada incorretamente
- Chave foi arquivada
- Chave foi deletada
- Tipo de API incorreto

**Solu√ß√£o**: Verifique a chave em Configura√ß√µes > APIs

### Problema: "Nenhum dado retornado"
**Poss√≠veis causas:**
- Nenhum im√≥vel cadastrado na empresa
- Todos os im√≥veis est√£o arquivados
- Nenhuma solicita√ß√£o de contato recebida

**Solu√ß√£o**: Verifique os dados no Dashboard

### Problema: "CORS Error"
**Solu√ß√£o**: As Edge Functions j√° t√™m CORS configurado (`Access-Control-Allow-Origin: *`)

---

## üìù Changelog

### v1.0.0 (24/10/2024)
- ‚úÖ Cria√ß√£o inicial das APIs
- ‚úÖ Autentica√ß√£o via API Key
- ‚úÖ Filtro autom√°tico por empresa
- ‚úÖ API de Im√≥veis (sem dados sens√≠veis)
- ‚úÖ API de Solicita√ß√µes de Contato
- ‚úÖ Gerenciamento de chaves (criar, arquivar, deletar)
- ‚úÖ Monitoramento de uso

---

## üí¨ Suporte

Para d√∫vidas ou problemas:
1. Consulte esta documenta√ß√£o
2. Verifique os logs no Supabase Dashboard
3. Entre em contato com o administrador do sistema

---

**üöÄ Pronto para integrar!** Use essas APIs para criar automa√ß√µes incr√≠veis com n8n, agentes de IA e muito mais!

